<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Grocery Data Entry</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #4f46e5; --primary-hover: #4338ca;
            --secondary-color: #64748b; --success-color: #16a34a; --danger-color: #dc2626;
            --bg-gradient-start: #f0f9ff; --bg-gradient-end: #e0f2fe;
            --card-bg: rgba(255, 255, 255, 0.85); --text-primary: #1e293b; --text-secondary: #475569;
            --border-color: #e2e8f0; --input-bg: #f8fafc; --shadow-color: rgba(71, 85, 105, 0.1);
            --backdrop-color: rgba(248, 250, 252, 0.5); --border-radius-lg: 16px;
            --border-radius-md: 10px; --transition-speed: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="dark"] {
            --primary-color: #818cf8; --primary-hover: #6366f1; --secondary-color: #94a3b8;
            --bg-gradient-start: #1e293b; --bg-gradient-end: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85); --text-primary: #f1f5f9; --text-secondary: #94a3b8;
            --border-color: #334155; --input-bg: #334155; --shadow-color: rgba(0, 0, 0, 0.2);
            --backdrop-color: rgba(15, 23, 42, 0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: var(--text-primary); min-height: 100vh; padding-bottom: 80px; }
        .app-header { padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 1.75rem; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .homepage-container { display: flex; justify-content: center; align-items: center; gap: 2rem; padding: 4rem 2rem; flex-wrap: wrap; }
        .homepage-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 2.5rem; text-align: center; cursor: pointer; box-shadow: 0 4px 15px var(--shadow-color); backdrop-filter: blur(10px); transition: transform var(--transition-speed), box-shadow var(--transition-speed); flex-basis: 320px; }
        .homepage-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px var(--shadow-color); }
        .homepage-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; }
        .homepage-card span { font-size: 1.25rem; font-weight: 500; display: block; }
        .workspace-container { max-width: 1000px; margin: 0 auto; padding: 0 2rem; }
        .workspace-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .list-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: 0 4px 15px var(--shadow-color); backdrop-filter: blur(10px); }
        .list-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        #searchInput { width: 100%; max-width: 400px; }
        .item-list-wrapper { max-height: 50vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); overscroll-behavior: contain; }
        .item-list { list-style-type: none; }
        .item-list li { display: grid; grid-template-columns: 1fr 1fr 2fr 1fr; gap: 1rem; padding: 0.85rem 1rem; border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-speed), box-shadow var(--transition-speed), transform var(--transition-speed); cursor: pointer; }
        .item-list li:last-child { border-bottom: none; }
        .item-list li.list-header-row { font-weight: 600; background-color: var(--input-bg); position: sticky; top: 0; z-index: 10; cursor: default; }
        .item-list li:not(.list-header-row):hover { background-color: var(--card-bg); transform: scale(1.02); box-shadow: 0 4px 15px var(--shadow-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--backdrop-color); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed), visibility var(--transition-speed); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border-color); padding: 2rem; border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px var(--shadow-color); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform var(--transition-speed); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); transition: color var(--transition-speed); }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: var(--input-bg); color: var(--text-primary); font-size: 1rem; font-family: var(--font-family); transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        input:read-only { background-color: var(--border-color); cursor: not-allowed; opacity: 0.7; }
        .uneditable-display { background-color: var(--input-bg); padding: 0.75rem; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); }
        .btn { padding: 0.75rem 1.5rem; border-radius: var(--border-radius-md); cursor: pointer; font-size: 1rem; font-weight: 500; font-family: var(--font-family); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; transition: all var(--transition-speed); }
        .btn:hover { transform: translateY(-2px); } .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: transparent; color: var(--text-primary); border-color: var(--border-color); } .btn-secondary:hover { background-color: var(--input-bg); }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .pending-changes-panel { position: sticky; bottom: 0; left: 0; width: 100%; z-index: 500; background: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -5px 20px var(--shadow-color); border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); backdrop-filter: blur(10px); transition: transform var(--transition-speed); transform: translateY(calc(100% - 60px)); }
        .pending-changes-panel.open { transform: translateY(0); }
        .panel-header { padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-header h3 { font-size: 1.1rem; font-weight: 600; }
        .panel-toggle-icon { transition: transform var(--transition-speed); }
        .pending-changes-panel.open .panel-toggle-icon { transform: rotate(180deg); }
        .panel-content { padding: 0 2rem 1.5rem 2rem; max-height: 40vh; overflow-y: auto; overscroll-behavior: contain; }
        .panel-actions { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; justify-content: space-between; align-items: center; }
        .panel-actions .action-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--text-primary); color: var(--card-bg); padding: 1rem 2rem; border-radius: var(--border-radius-md); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.5s, transform 0.5s, bottom 0.5s; }
        .toast-notification.show { opacity: 1; bottom: 40px; }
        .app-footer { text-align: center; padding: 2rem; }
        .app-footer button { font-size: 0.9rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; }
        .app-footer button:hover { color: var(--danger-color); }

        @media (max-width: 768px) {
            .app-header { flex-direction: column; gap: 1rem; padding: 1rem; }
            .workspace-container, .homepage-container { padding: 1rem; }
            .list-header-controls { flex-direction: column; align-items: stretch; }
            #searchInput { max-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .panel-header, .panel-content { padding-left: 1rem; padding-right: 1rem; }
            .panel-actions { flex-direction: column; align-items: stretch; }
            .panel-actions .action-group { justify-content: center; }
        }
        @media (max-width: 640px) {
            .item-list li:not(.list-header-row) { grid-template-areas: "name name" "code plu" "status status"; grid-template-columns: 1fr 1fr; padding: 1rem; gap: 0.25rem 1rem; }
            .item-list li span:nth-child(1) { grid-area: code; font-size: 0.8em; color: var(--text-secondary); }
            .item-list li span:nth-child(2) { grid-area: plu; font-size: 0.8em; color: var(--text-secondary); }
            .item-list li span:nth-child(3) { grid-area: name; font-size: 1.1em; font-weight: 500; margin-bottom: 0.5rem; }
            .item-list li span:nth-child(4) { grid-area: status; font-size: 0.8em; justify-self: start; background: var(--input-bg); padding: 0.2rem 0.5rem; border-radius: 6px; margin-top: 0.5rem; }
            .item-list-wrapper { max-height: 60vh; }
            .list-header-row { display: none; }
            .table-wrapper table thead { display: none; }
            .table-wrapper table, .table-wrapper table tbody, .table-wrapper table tr { display: block; width: 100%; }
            .table-wrapper table tr { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 1.25rem; margin-bottom: 1rem; position: relative; box-shadow: 0 2px 8px var(--shadow-color); }
            .table-wrapper table td { display: block; padding: 0.4rem 0; border: none; white-space: normal; }
            .table-wrapper table td:first-child { font-weight: 600; font-size: 1.1em; margin-bottom: 0.75rem; padding-right: 35px; }
            .table-wrapper table td:not(:first-child)::before { content: attr(data-label) ": "; font-weight: 500; color: var(--text-secondary); margin-left: 0.5rem; }
            .delete-card-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--danger-color); font-size: 1.3rem; cursor: pointer; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1><i class="fa-solid fa-store"></i> إدارة الأصناف</h1>
        <div class="header-actions">
            <!-- FIXED: Removed onclick, gave it an ID -->
            <button id="homeButton" class="btn btn-secondary"><i class="fa-solid fa-house"></i> الرئيسية</button>
            <div class="theme-switch-wrapper">
                <i class="fas fa-sun"></i>
                <label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox" /><div class="slider round"></div></label>
                <i class="fas fa-moon"></i>
            </div>
        </div>
    </header>

    <main id="app-main">
        <div id="homepage" class="homepage-container">
            <!-- FIXED: Removed onclick, gave them IDs -->
            <div id="editCard" class="homepage-card"><i class="fas fa-tags"></i><span>تعديل أسعار الأصناف</span></div>
            <div id="addCard" class="homepage-card"><i class="fas fa-plus-circle"></i><span>إضافة صنف جديد</span></div>
        </div>
        <div id="workspace" class="workspace-container" style="display: none;">
            <h2 class="workspace-title"><i class="fa-solid fa-list-ul"></i> قائمة الأصناف</h2>
            <div class="list-container">
                <div class="list-header-controls">
                    <input type="text" id="searchInput" class="btn" placeholder="بحث بالاسم أو الكود...">
                    <button id="showAddItemModalBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> إضافة صنف جديد</button>
                </div>
                <div class="item-list-wrapper">
                    <ul id="itemList" class="item-list">
                        <li class="list-header-row"><span>الكود</span><span>كود PLU</span><span>الاسم</span><span>الحالة</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    
    <!-- All Modals are now here in the body for clarity -->
    <div id="editItemModal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h2>تعديل بيانات الصنف</h2><button class="modal-close-btn">×</button></div><div class="modal-body"><div class="form-grid"><div class="form-group full-width"><label>الاسم</label><div id="nameDisplay" class="uneditable-display"></div></div><div class="form-group"><label>الكود</label><div id="codeDisplay" class="uneditable-display"></div></div><div class="form-group"><label>الحالة الحالية</label><div id="statusDisplay" class="uneditable-display"></div></div></div><hr style="border:none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;"><div class="form-grid"><div class="form-group"><label for="costInput">التكلفة</label><input type="number" id="costInput" step="0.001" placeholder="أدخل التكلفة"></div><div class="form-group"><label for="supplierInput">المورد</label><input type="text" id="supplierInput" placeholder="اسم المورد"></div><div class="form-group"><label for="cairoMarginInput">نسبة القاهرة (%)</label><input type="number" id="cairoMarginInput" step="0.001" placeholder="أدخل النسبة"></div><div class="form-group"><label for="coastMarginInput">نسبة الساحل (%)</label><input type="number" id="coastMarginInput" step="0.001" placeholder="أدخل النسبة"></div><div class="form-group"><label for="cairoCostInput">سعر القاهرة</label><input type="number" id="cairoCostInput" step="0.001" placeholder="يُحسب تلقائياً" readonly></div><div class="form-group"><label for="sahelCostInput">سعر الساحل</label><input type="number" id="sahelCostInput" step="0.001" placeholder="يُحسب تلقائياً" readonly></div><div class="form-group"><label for="newStatusInput">الحالة الجديدة</label><select id="newStatusInput"><option value="" selected>بدون تغيير</option><option value="جاري">جاري</option><option value="موقوف">موقوف</option></select></div><div class="form-group"><label for="expiryInput">صلاحية (يوم)</label><input type="number" id="expiryInput" placeholder="e.g., 30"></div></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">إلغاء</button><button id="addButton" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> حفظ التغييرات</button></div></div>
    </div>
    <div id="addNewItemModal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h2>إضافة صنف جديد</h2><button class="modal-close-btn">×</button></div><div class="modal-body"><div class="form-grid"><div class="form-group full-width"><label for="newItemName">اسم الصنف</label><input type="text" id="newItemName" placeholder="مثال: جبنة فيتا"></div><div class="form-group"><label for="newItemCost">التكلفة</label><input type="number" id="newItemCost" step="0.001" placeholder="أدخل التكلفة"></div><div class="form-group"><label for="newItemSupplier">المورد</label><input type="text" id="newItemSupplier" placeholder="اسم المورد"></div><div class="form-group"><label for="newItemCairoMargin">نسبة القاهرة (%)</label><input type="number" id="newItemCairoMargin" step="0.001" placeholder="أدخل النسبة"></div><div class="form-group"><label for="newItemCoastMargin">نسبة الساحل (%)</label><input type="number" id="newItemCoastMargin" step="0.001" placeholder="أدخل النسبة"></div><div class="form-group"><label for="newItemCairoCost">سعر القاهرة</label><input type="number" id="newItemCairoCost" step="0.001" placeholder="يُحسب تلقائياً" readonly></div><div class="form-group"><label for="newItemSahelCost">سعر الساحل</label><input type="number" id="newItemSahelCost" step="0.001" placeholder="يُحسب تلقائياً" readonly></div><div class="form-group full-width"><label for="newItemExpiry">صلاحية (يوم)</label><input type="number" id="newItemExpiry" placeholder="e.g., 90"></div></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">إلغاء</button><button id="addNewItemButton" class="btn btn-primary"><i class="fa-solid fa-plus"></i> إضافة الصنف</button></div></div>
    </div>
    
    <div id="pendingChangesPanel" class="pending-changes-panel">
        <!-- FIXED: Removed onclick, gave header an ID -->
        <div id="panelHeader" class="panel-header"><h3><i class="fa-solid fa-list-check"></i> التغييرات المعلقة (<span id="changesCount">0</span>)</h3><i id="panelToggleIcon" class="fa-solid fa-chevron-up panel-toggle-icon"></i></div>
        <div class="panel-content">
            <div class="panel-actions">
                <div class="action-group">
                    <button id="extractButton" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Excel</button>
                    <button id="saveImageButton" class="btn btn-secondary"><i class="fas fa-file-image"></i> صورة</button>
                </div>
                <button id="clearTableButton" class="btn btn-danger"><i class="fas fa-trash-alt"></i> مسح الكل</button>
            </div>
            <div id="editChanges" class="table-wrapper"><h4>تعديلات الأسعار</h4><table id="dataTable"><thead><tr><th>الكود</th><th>الاسم</th><th>التكلفة</th><th>القاهرة</th><th>الساحل</th><th>المورد</th><th>الحالة الجديدة</th><th>حذف</th></tr></thead><tbody id="dataTableBody"></tbody></table></div>
            <hr style="border:none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">
            <div id="newChanges" class="table-wrapper"><h4>أصناف جديدة</h4><table id="dataTableNewItem"><thead><tr><th>الاسم</th><th>التكلفة</th><th>القاهرة</th><th>الساحل</th><th>المورد</th><th>حذف</th></tr></thead><tbody id="dataTableBodyNewItem"></tbody></table></div>
        </div>
    </div>
    
    <footer class="app-footer">
        <button id="clearLocalStorageButton"><i class="fas fa-eraser"></i> مسح جميع البيانات المحفوظة والبدء من جديد</button>
    </footer>

    <div id="toast" class="toast-notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // --- GLOBAL STATE ---
        let database = [];
        let selectedItem = null;
        let pendingEdits = [];
        let pendingNewItems = [];
        const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfw5j64mu2wbzx-22AGTlXGWKgCKnssOPjNHrQ6xo-_zDBloRVL2DoTmWSKPFfzg/pub?output=csv';

        // --- CORE APP LOGIC ---
        const formatDecimal = num => parseFloat(num) ? parseFloat(num).toFixed(3) : "0.000";
        const calculatePrice = (cost, margin) => (cost > 0 && margin >= 0 && margin < 100) ? cost / (1 - (margin / 100)) : 0;
        
        function showHomepage() {
            document.getElementById('homepage').style.display = 'flex';
            document.getElementById('workspace').style.display = 'none';
        }

        function showWorkspace(mode) {
            document.getElementById('homepage').style.display = 'none';
            document.getElementById('workspace').style.display = 'block';
            if (mode === 'add') {
                openModal(document.getElementById('addNewItemModal'));
            }
        }

        function togglePanel() {
            document.getElementById('pendingChangesPanel').classList.toggle('open');
        }

        function openModal(modal) { modal.classList.add('active'); }
        function closeModal(modal) { modal.classList.remove('active'); }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            initTheme();
            initEventListeners();
            loadStateFromLocalStorage();
            fetchDataFromGoogleSheet();
        }

        // --- EVENT LISTENERS (CENTRALIZED)---
        function initEventListeners() {
            // Navigation
            document.getElementById('homeButton').addEventListener('click', showHomepage);
            document.getElementById('editCard').addEventListener('click', () => showWorkspace('edit'));
            document.getElementById('addCard').addEventListener('click', () => showWorkspace('add'));

            // Panel
            document.getElementById('panelHeader').addEventListener('click', togglePanel);
            document.getElementById('extractButton').addEventListener('click', exportToExcel);
            document.getElementById('saveImageButton').addEventListener('click', savePanelAsImage);
            document.getElementById('clearTableButton').addEventListener('click', clearAllPendingChanges);
            
            // Search
            document.getElementById('searchInput').addEventListener('input', e => {
                const term = e.target.value.toLowerCase();
                const filtered = database.filter(item => Object.values(item).some(val => String(val).toLowerCase().includes(term)));
                renderList(filtered);
            });
            
            // Modals
            document.getElementById('showAddItemModalBtn').addEventListener('click', () => {
                resetAddModal();
                openModal(document.getElementById('addNewItemModal'));
            });
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.closest('.modal-overlay')));
            });
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeModal(overlay);
                });
            });

            // Modal Actions
            document.getElementById('addButton').addEventListener('click', handleAddEditedItem);
            document.getElementById('addNewItemButton').addEventListener('click', handleAddNewItem);
            
            // Auto-calculation
            ['costInput', 'cairoMarginInput', 'coastMarginInput'].forEach(id => document.getElementById(id).addEventListener('input', updateCalculatedPrices));
            ['newItemCost', 'newItemCairoMargin', 'newItemCoastMargin'].forEach(id => document.getElementById(id).addEventListener('input', updateCalculatedNewItemPrices));

            // Footer
            document.getElementById('clearLocalStorageButton').addEventListener('click', clearLocalStorage);
        }

        // --- ACTION HANDLERS ---
        function handleAddEditedItem() {
            if (!selectedItem || !(parseFloat(document.getElementById('costInput').value) > 0)) {
                showToast('الرجاء إدخال تكلفة صحيحة.', 'danger'); return;
            }
            const itemData = {
                id: selectedItem.code, // Use a unique identifier
                code: selectedItem.code,
                name: selectedItem.name,
                cost: formatDecimal(document.getElementById('costInput').value),
                cairoPrice: formatDecimal(document.getElementById('cairoCostInput').value),
                sahelPrice: formatDecimal(document.getElementById('sahelCostInput').value),
                supplier: document.getElementById('supplierInput').value || 'N/A',
                newStatus: document.getElementById('newStatusInput').value || 'بدون تغيير'
            };
            addEditedItem(itemData);
        }

        function handleAddNewItem() {
            const name = document.getElementById('newItemName').value;
            if (!name.trim() || !(parseFloat(document.getElementById('newItemCost').value) > 0)) {
                 showToast('الرجاء إدخال اسم وتكلفة صحيحين.', 'danger'); return;
            }
            const itemData = {
                id: `new-${Date.now()}`, // Generate a temporary unique ID
                name: name,
                cost: formatDecimal(document.getElementById('newItemCost').value),
                cairoPrice: formatDecimal(document.getElementById('newItemCairoCost').value),
                sahelPrice: formatDecimal(document.getElementById('newItemSahelCost').value),
                supplier: document.getElementById('newItemSupplier').value || 'N/A',
            };
            addNewItem(itemData);
        }

        // --- DATA MANAGEMENT & PERSISTENCE ---
        function addEditedItem(itemData) {
            // Prevent duplicates
            const existingIndex = pendingEdits.findIndex(item => item.id === itemData.id);
            if (existingIndex > -1) {
                pendingEdits[existingIndex] = itemData; // Update existing
            } else {
                pendingEdits.push(itemData);
            }
            saveStateToLocalStorage();
            renderPendingChanges();
            closeModal(document.getElementById('editItemModal'));
            showToast('✅ تم إضافة التعديل بنجاح', 'success');
            if (!document.getElementById('pendingChangesPanel').classList.contains('open')) togglePanel();
        }

        function addNewItem(itemData) {
            pendingNewItems.push(itemData);
            saveStateToLocalStorage();
            renderPendingChanges();
            closeModal(document.getElementById('addNewItemModal'));
            showToast('✅ تم إضافة الصنف الجديد بنجاح', 'success');
            if (!document.getElementById('pendingChangesPanel').classList.contains('open')) togglePanel();
        }

        function deleteEditedItem(index) { /* ... same as before ... */ }
        function deleteNewItem(index) { /* ... same as before ... */ }
        
        function clearAllPendingChanges() { /* ... same as before ... */ }

        function saveStateToLocalStorage() { /* ... same as before ... */ }
        function loadStateFromLocalStorage() { /* ... same as before ... */ }
        function clearLocalStorage() { /* ... same as before ... */ }

        // --- RENDERING & UI ---
        function renderPendingChanges() { /* ... same as before ... */ }
        function updateChangesCount() { /* ... same as before ... */ }
        function renderList(listData) { /* ... same as before ... */ }
        function showToast(message, type = 'success') { /* ... same as before ... */ }
        function initTheme() { /* ... same as before ... */ }
        
        // Modal helpers
        function resetEditModalInputs() { /* ... same as before ... */ }
        function resetAddModal() { /* ... same as before ... */ }

        // Auto-calculation functions
        function updateCalculatedPrices() { /* ... same as before ... */ }
        function updateCalculatedNewItemPrices() { /* ... same as before ... */ }
        
        // Data Fetching
        async function fetchDataFromGoogleSheet() { /* ... same as before ... */ }
        
        // Item selection
        function selectItemForEditing(item) { /* ... same as before ... */ }

        // FIXED: Re-implemented missing functions
        function exportToExcel() {
            if (pendingEdits.length === 0 && pendingNewItems.length === 0) {
                showToast('لا توجد تغييرات للتصدير.', 'danger');
                return;
            }
            const wb = XLSX.utils.book_new();
            if (pendingEdits.length > 0) {
                const ws1 = XLSX.utils.table_to_sheet(document.getElementById('dataTable'));
                XLSX.utils.book_append_sheet(wb, ws1, "تعديلات الأسعار");
            }
            if (pendingNewItems.length > 0) {
                const ws2 = XLSX.utils.table_to_sheet(document.getElementById('dataTableNewItem'));
                XLSX.utils.book_append_sheet(wb, ws2, "أصناف جديدة");
            }
            XLSX.writeFile(wb, "grocery_changes.xlsx");
            showToast('✅ تم تصدير الملف بنجاح', 'success');
        }

        function savePanelAsImage() {
            if (pendingEdits.length === 0 && pendingNewItems.length === 0) {
                showToast('لا توجد تغييرات لحفظها كصورة.', 'danger');
                return;
            }
            const panelContent = document.querySelector('.panel-content');
            html2canvas(panelContent, { scale: 2, useCORS: true, backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' ? '#0f172a' : '#f0f9ff' }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'pending_changes.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            });
        }
    </script>
</body>
</html>
