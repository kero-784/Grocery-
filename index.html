<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Grocery Data Entry</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --primary-color: #4f46e5; --primary-hover: #4338ca;
            --secondary-color: #64748b; --success-color: #16a34a; --danger-color: #dc2626;
            --bg-gradient-start: #f0f9ff; --bg-gradient-end: #e0f2fe;
            --card-bg: rgba(255, 255, 255, 0.85); --text-primary: #1e293b; --text-secondary: #475569;
            --border-color: #e2e8f0; --input-bg: #f8fafc; --shadow-color: rgba(71, 85, 105, 0.1);
            --backdrop-color: rgba(248, 250, 252, 0.5); --border-radius-lg: 16px;
            --border-radius-md: 10px; --transition-speed: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        [data-theme="dark"] {
            --primary-color: #818cf8; --primary-hover: #6366f1; --secondary-color: #94a3b8;
            --bg-gradient-start: #1e293b; --bg-gradient-end: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85); --text-primary: #f1f5f9; --text-secondary: #94a3b8;
            --border-color: #334155; --input-bg: #334155; --shadow-color: rgba(0, 0, 0, 0.2);
            --backdrop-color: rgba(15, 23, 42, 0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-family); background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); color: var(--text-primary); min-height: 100vh; padding-bottom: 80px; }
        .app-header { padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 1.75rem; font-weight: 600; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .homepage-container { display: flex; justify-content: center; align-items: center; gap: 2rem; padding: 4rem 2rem; flex-wrap: wrap; }
        .homepage-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 2.5rem; text-align: center; cursor: pointer; box-shadow: 0 4px 15px var(--shadow-color); backdrop-filter: blur(10px); transition: transform var(--transition-speed), box-shadow var(--transition-speed); flex-basis: 320px; }
        .homepage-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px var(--shadow-color); }
        .homepage-card i { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; }
        .homepage-card span { font-size: 1.25rem; font-weight: 500; display: block; }
        .workspace-container { max-width: 1000px; margin: 0 auto; padding: 0 2rem; }
        .workspace-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .list-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: 0 4px 15px var(--shadow-color); backdrop-filter: blur(10px); }
        .list-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        #searchInput { width: 100%; max-width: 400px; }
        .item-list-wrapper { max-height: 50vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); overscroll-behavior: contain; }
        .item-list { list-style-type: none; }
        .item-list li { display: grid; grid-template-columns: 1fr 1fr 2fr 1fr; gap: 1rem; padding: 0.85rem 1rem; border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-speed), box-shadow var(--transition-speed), transform var(--transition-speed); cursor: pointer; }
        .item-list li:last-child { border-bottom: none; }
        .item-list li.list-header-row { font-weight: 600; background-color: var(--input-bg); position: sticky; top: 0; z-index: 10; cursor: default; }
        .item-list li:not(.list-header-row):hover { background-color: var(--card-bg); transform: scale(1.02); box-shadow: 0 4px 15px var(--shadow-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--backdrop-color); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed), visibility var(--transition-speed); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border-color); padding: 2rem; border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px var(--shadow-color); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform var(--transition-speed); }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-header h2 { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); transition: color var(--transition-speed); }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: span 2; }
        .form-group label { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: var(--input-bg); color: var(--text-primary); font-size: 1rem; font-family: var(--font-family); transition: border-color var(--transition-speed), box-shadow var(--transition-speed); }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        input:read-only { background-color: var(--border-color); cursor: not-allowed; opacity: 0.7; }
        .uneditable-display { background-color: var(--input-bg); padding: 0.75rem; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); }
        .btn { padding: 0.75rem 1.5rem; border-radius: var(--border-radius-md); cursor: pointer; font-size: 1rem; font-weight: 500; font-family: var(--font-family); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 1px solid transparent; transition: all var(--transition-speed); }
        .btn:hover { transform: translateY(-2px); } .btn:active { transform: translateY(0); }
        .btn-primary { background-color: var(--primary-color); color: #fff; } .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: transparent; color: var(--text-primary); border-color: var(--border-color); } .btn-secondary:hover { background-color: var(--input-bg); }
        .btn-danger { background-color: var(--danger-color); color: #fff; }
        .pending-changes-panel { position: sticky; bottom: 0; left: 0; width: 100%; z-index: 500; background: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -5px 20px var(--shadow-color); border-top-left-radius: var(--border-radius-lg); border-top-right-radius: var(--border-radius-lg); backdrop-filter: blur(10px); transition: transform var(--transition-speed); transform: translateY(calc(100% - 60px)); }
        .pending-changes-panel.open { transform: translateY(0); }
        .panel-header { padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-header h3 { font-size: 1.1rem; font-weight: 600; }
        .panel-toggle-icon { transition: transform var(--transition-speed); }
        .pending-changes-panel.open .panel-toggle-icon { transform: rotate(180deg); }
        .panel-content { padding: 0 2rem 1.5rem 2rem; max-height: 40vh; overflow-y: auto; overscroll-behavior: contain; }
        .panel-actions { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; justify-content: space-between; align-items: center; }
        .panel-actions .action-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .table-wrapper { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 0.95em; }
        th, td { border-bottom: 1px solid var(--border-color); padding: 0.85rem 1rem; text-align: right; white-space: nowrap; }
        th { font-weight: 600; }
        tbody tr:last-child td { border-bottom: none; }
        
        /* FEATURE: Toast Notification Styling */
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--text-primary); color: var(--card-bg); padding: 1rem 2rem; border-radius: var(--border-radius-md); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 2000; opacity: 0; transition: opacity 0.5s, transform 0.5s, bottom 0.5s; }
        .toast-notification.show { opacity: 1; bottom: 40px; }

        /* FEATURE: App Footer for extra actions */
        .app-footer { text-align: center; padding: 2rem; }
        .app-footer button { font-size: 0.9rem; color: var(--text-secondary); background: none; border: none; cursor: pointer; }
        .app-footer button:hover { color: var(--danger-color); }

        @media (max-width: 768px) {
            .app-header { flex-direction: column; gap: 1rem; padding: 1rem; }
            .workspace-container, .homepage-container { padding: 1rem; }
            .list-header-controls { flex-direction: column; align-items: stretch; }
            #searchInput { max-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .panel-header, .panel-content { padding-left: 1rem; padding-right: 1rem; }
            .panel-actions { flex-direction: column; align-items: stretch; }
            .panel-actions .action-group { justify-content: center; }
        }
        @media (max-width: 640px) {
            .item-list li:not(.list-header-row) { grid-template-areas: "name name" "code plu" "status status"; grid-template-columns: 1fr 1fr; padding: 1rem; gap: 0.25rem 1rem; }
            .item-list li span:nth-child(1) { grid-area: code; font-size: 0.8em; color: var(--text-secondary); }
            .item-list li span:nth-child(2) { grid-area: plu; font-size: 0.8em; color: var(--text-secondary); }
            .item-list li span:nth-child(3) { grid-area: name; font-size: 1.1em; font-weight: 500; margin-bottom: 0.5rem; }
            .item-list li span:nth-child(4) { grid-area: status; font-size: 0.8em; justify-self: start; background: var(--input-bg); padding: 0.2rem 0.5rem; border-radius: 6px; margin-top: 0.5rem; }
            .item-list-wrapper { max-height: 60vh; }
            .list-header-row { display: none; }
            
            /* FEATURE: New Card-Based Layout for Mobile Pending Changes Table */
            .table-wrapper table thead { display: none; }
            .table-wrapper table, .table-wrapper table tbody, .table-wrapper table tr { display: block; width: 100%; }
            .table-wrapper table tr {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius-md);
                padding: 1.25rem;
                margin-bottom: 1rem;
                position: relative;
                box-shadow: 0 2px 8px var(--shadow-color);
            }
            .table-wrapper table td { display: block; padding: 0.4rem 0; border: none; white-space: normal; }
            .table-wrapper table td:first-child { font-weight: 600; font-size: 1.1em; margin-bottom: 0.75rem; padding-right: 35px; /* Space for delete button */ }
            .table-wrapper table td:not(:first-child)::before {
                content: attr(data-label) ": ";
                font-weight: 500;
                color: var(--text-secondary);
                margin-left: 0.5rem;
            }
            /* Position delete button in top-right of the card */
            .delete-card-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: none;
                border: none;
                color: var(--danger-color);
                font-size: 1.3rem;
                cursor: pointer;
            }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1><i class="fa-solid fa-store"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showHomepage()"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <div class="theme-switch-wrapper">
                <i class="fas fa-sun"></i>
                <label class="theme-switch" for="checkbox"><input type="checkbox" id="checkbox" /><div class="slider round"></div></label>
                <i class="fas fa-moon"></i>
            </div>
        </div>
    </header>

    <main id="app-main">
        <div id="homepage" class="homepage-container">
            <div class="homepage-card" onclick="showWorkspace('edit')"><i class="fas fa-tags"></i><span>ØªØ¹Ø¯ÙŠÙ„ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù</span></div>
            <div class="homepage-card" onclick="showWorkspace('add')"><i class="fas fa-plus-circle"></i><span>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</span></div>
        </div>
        <div id="workspace" class="workspace-container" style="display: none;">
            <h2 class="workspace-title"><i class="fa-solid fa-list-ul"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
            <div class="list-container">
                <div class="list-header-controls">
                    <input type="text" id="searchInput" class="btn" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                    <button id="showAddItemModalBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div class="item-list-wrapper">
                    <ul id="itemList" class="item-list"></ul>
                </div>
            </div>
        </div>
    </main>
    
    <!-- All Modals are unchanged -->
    <div id="editItemModal" class="modal-overlay"><!-- ... modal content ... --></div>
    <div id="addNewItemModal" class="modal-overlay"><!-- ... modal content ... --></div>
    
    <div id="pendingChangesPanel" class="pending-changes-panel">
        <div class="panel-header" onclick="togglePanel()"><h3><i class="fa-solid fa-list-check"></i> Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (<span id="changesCount">0</span>)</h3><i id="panelToggleIcon" class="fa-solid fa-chevron-up panel-toggle-icon"></i></div>
        <div class="panel-content">
            <div class="panel-actions">
                <div class="action-group">
                    <button id="extractButton" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Excel</button>
                    <button id="saveImageButton" class="btn btn-secondary"><i class="fas fa-file-image"></i> ØµÙˆØ±Ø©</button>
                </div>
                <button id="clearTableButton" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>
            <div id="editChanges" class="table-wrapper"><h4>ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h4><table id="dataTable"><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</th><th>Ø§Ù„Ø³Ø§Ø­Ù„</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="dataTableBody"></tbody></table></div>
            <hr style="border:none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">
            <div id="newChanges" class="table-wrapper"><h4>Ø£ØµÙ†Ø§Ù Ø¬Ø¯ÙŠØ¯Ø©</h4><table id="dataTableNewItem"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</th><th>Ø§Ù„Ø³Ø§Ø­Ù„</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø­Ø°Ù</th></tr></thead><tbody id="dataTableBodyNewItem"></tbody></table></div>
        </div>
    </div>
    
    <!-- FEATURE: Footer for extra actions -->
    <footer class="app-footer">
        <button id="clearLocalStorageButton"><i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
    </footer>

    <!-- FEATURE: Toast Notification element -->
    <div id="toast" class="toast-notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // --- MODAL HTML (kept here to simplify the file) ---
        document.getElementById('editItemModal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù</h2><button class="modal-close-btn">Ã—</button></div><div class="modal-body"><div class="form-grid"><div class="form-group full-width"><label>Ø§Ù„Ø§Ø³Ù…</label><div id="nameDisplay" class="uneditable-display"></div></div><div class="form-group"><label>Ø§Ù„ÙƒÙˆØ¯</label><div id="codeDisplay" class="uneditable-display"></div></div><div class="form-group"><label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label><div id="statusDisplay" class="uneditable-display"></div></div></div><hr style="border:none; border-top: 1px solid var(--border-color); margin: 1.5rem 0;"><div class="form-grid"><div class="form-group"><label for="costInput">Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" id="costInput" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙƒÙ„ÙØ©"></div><div class="form-group"><label for="supplierInput">Ø§Ù„Ù…ÙˆØ±Ø¯</label><input type="text" id="supplierInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯"></div><div class="form-group"><label for="cairoMarginInput">Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© (%)</label><input type="number" id="cairoMarginInput" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø©"></div><div class="form-group"><label for="coastMarginInput">Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø­Ù„ (%)</label><input type="number" id="coastMarginInput" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø©"></div><div class="form-group"><label for="cairoCostInput">Ø³Ø¹Ø± Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</label><input type="number" id="cairoCostInput" step="0.001" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly></div><div class="form-group"><label for="sahelCostInput">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø­Ù„</label><input type="number" id="sahelCostInput" step="0.001" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly></div><div class="form-group"><label for="newStatusInput">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label><select id="newStatusInput"><option value="" selected>Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±</option><option value="Ø¬Ø§Ø±ÙŠ">Ø¬Ø§Ø±ÙŠ</option><option value="Ù…ÙˆÙ‚ÙˆÙ">Ù…ÙˆÙ‚ÙˆÙ</option></select></div><div class="form-group"><label for="expiryInput">ØµÙ„Ø§Ø­ÙŠØ© (ÙŠÙˆÙ…)</label><input type="number" id="expiryInput" placeholder="e.g., 30"></div></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">Ø¥Ù„ØºØ§Ø¡</button><button id="addButton" class="btn btn-primary"><i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button></div></div>`;
        document.getElementById('addNewItemModal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h2><button class="modal-close-btn">Ã—</button></div><div class="modal-body"><div class="form-grid"><div class="form-group full-width"><label for="newItemName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label><input type="text" id="newItemName" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø¨Ù†Ø© ÙÙŠØªØ§"></div><div class="form-group"><label for="newItemCost">Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" id="newItemCost" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ØªÙƒÙ„ÙØ©"></div><div class="form-group"><label for="newItemSupplier">Ø§Ù„Ù…ÙˆØ±Ø¯</label><input type="text" id="newItemSupplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯"></div><div class="form-group"><label for="newItemCairoMargin">Ù†Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© (%)</label><input type="number" id="newItemCairoMargin" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø©"></div><div class="form-group"><label for="newItemCoastMargin">Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø§Ø­Ù„ (%)</label><input type="number" id="newItemCoastMargin" step="0.001" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø³Ø¨Ø©"></div><div class="form-group"><label for="newItemCairoCost">Ø³Ø¹Ø± Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</label><input type="number" id="newItemCairoCost" step="0.001" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly></div><div class="form-group"><label for="newItemSahelCost">Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø­Ù„</label><input type="number" id="newItemSahelCost" step="0.001" placeholder="ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly></div><div class="form-group full-width"><label for="newItemExpiry">ØµÙ„Ø§Ø­ÙŠØ© (ÙŠÙˆÙ…)</label><input type="number" id="newItemExpiry" placeholder="e.g., 90"></div></div></div><div class="modal-footer"><button class="btn btn-secondary modal-close-btn">Ø¥Ù„ØºØ§Ø¡</button><button id="addNewItemButton" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù</button></div></div>`;

        // --- GLOBAL STATE ---
        let database = [];
        let selectedItem = null;
        let pendingEdits = [];
        let pendingNewItems = [];
        const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfw5j64mu2wbzx-22AGTlXGWKgCKnssOPjNHrQ6xo-_zDBloRVL2DoTmWSKPFfzg/pub?output=csv';

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            fetchDataFromGoogleSheet();
        });

        function initApp() {
            initTheme();
            initEventListeners();
            loadStateFromLocalStorage(); // FEATURE: Load saved data on start
        }

        function initEventListeners() {
            document.getElementById('showAddItemModalBtn').addEventListener('click', () => openModalById('addNewItemModal'));
            document.getElementById('clearTableButton').addEventListener('click', clearAllPendingChanges);
            document.getElementById('extractButton').addEventListener('click', exportToExcel);
            document.getElementById('saveImageButton').addEventListener('click', savePanelAsImage);
            document.getElementById('clearLocalStorageButton').addEventListener('click', clearLocalStorage);
        }
        
        // --- THEME ---
        function initTheme() { /* ... unchanged ... */ }

        // --- LOCAL STORAGE PERSISTENCE FEATURE ---
        function saveStateToLocalStorage() {
            localStorage.setItem('pendingEdits', JSON.stringify(pendingEdits));
            localStorage.setItem('pendingNewItems', JSON.stringify(pendingNewItems));
        }

        function loadStateFromLocalStorage() {
            pendingEdits = JSON.parse(localStorage.getItem('pendingEdits')) || [];
            pendingNewItems = JSON.parse(localStorage.getItem('pendingNewItems')) || [];
            renderPendingChanges();
            showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'success');
        }

        function clearLocalStorage() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.')) {
                localStorage.removeItem('pendingEdits');
                localStorage.removeItem('pendingNewItems');
                pendingEdits = [];
                pendingNewItems = [];
                renderPendingChanges();
                showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        }

        // --- UI & MODALS ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // --- DATA HANDLING ---
        function addEditedItem(itemData) {
            pendingEdits.push(itemData);
            saveStateToLocalStorage();
            renderPendingChanges();
            closeModalById('editItemModal');
            showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            if (!document.getElementById('pendingChangesPanel').classList.contains('open')) {
                togglePanel();
            }
        }

        function addNewItem(itemData) {
            pendingNewItems.push(itemData);
            saveStateToLocalStorage();
            renderPendingChanges();
            closeModalById('addNewItemModal');
            showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
            if (!document.getElementById('pendingChangesPanel').classList.contains('open')) {
                togglePanel();
            }
        }

        function deleteEditedItem(index) {
            pendingEdits.splice(index, 1);
            saveStateToLocalStorage();
            renderPendingChanges();
            showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'danger');
        }

        function deleteNewItem(index) {
            pendingNewItems.splice(index, 1);
            saveStateToLocalStorage();
            renderPendingChanges();
            showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'danger');
        }

        function clearAllPendingChanges() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©ØŸ')) {
                pendingEdits = [];
                pendingNewItems = [];
                saveStateToLocalStorage();
                renderPendingChanges();
                showToast('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª', 'danger');
            }
        }

        // --- RENDERING ---
        function renderPendingChanges() {
            const editBody = document.getElementById('dataTableBody');
            const newBody = document.getElementById('dataTableBodyNewItem');
            editBody.innerHTML = '';
            newBody.innerHTML = '';

            pendingEdits.forEach((item, index) => {
                const newRow = editBody.insertRow();
                newRow.innerHTML = `
                    <td data-label="Ø§Ù„ÙƒÙˆØ¯">${item.code}</td>
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${item.name}</td>
                    <td data-label="Ø§Ù„ØªÙƒÙ„ÙØ©">${item.cost}</td>
                    <td data-label="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">${item.cairoPrice}</td>
                    <td data-label="Ø§Ù„Ø³Ø§Ø­Ù„">${item.sahelPrice}</td>
                    <td data-label="Ø§Ù„Ù…ÙˆØ±Ø¯">${item.supplier}</td>
                    <td data-label="Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">${item.newStatus}</td>
                    <td><button class="delete-card-btn" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-trash-alt"></i></button></td>`;
                newRow.querySelector('.delete-card-btn').onclick = () => deleteEditedItem(index);
            });

            pendingNewItems.forEach((item, index) => {
                const newRow = newBody.insertRow();
                newRow.innerHTML = `
                    <td data-label="Ø§Ù„Ø§Ø³Ù…">${item.name}</td>
                    <td data-label="Ø§Ù„ØªÙƒÙ„ÙØ©">${item.cost}</td>
                    <td data-label="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">${item.cairoPrice}</td>
                    <td data-label="Ø§Ù„Ø³Ø§Ø­Ù„">${item.sahelPrice}</td>
                    <td data-label="Ø§Ù„Ù…ÙˆØ±Ø¯">${item.supplier}</td>
                    <td><button class="delete-card-btn" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù"><i class="fas fa-trash-alt"></i></button></td>`;
                newRow.querySelector('.delete-card-btn').onclick = () => deleteNewItem(index);
            });
            updateChangesCount();
        }
        
        function updateChangesCount() {
            const count = pendingEdits.length + pendingNewItems.length;
            document.getElementById('changesCount').textContent = count;
        }

        // --- Rest of your script logic, adapted for new data flow ---
        // (fetchDataFromGoogleSheet, renderList, selectItemForEditing, etc.)
        // These are mostly unchanged, but now call the new data handling functions.
        async function fetchDataFromGoogleSheet() { /* ... unchanged ... */ }
        function renderList(listData) { /* ... unchanged but place it here ... */ }

        // The logic inside button clicks now collects data and passes it to the handler functions.
        document.getElementById('addButton').addEventListener('click', () => {
             // validation and data collection
             addEditedItem({ /* collected data object */ });
        });
        document.getElementById('addNewItemButton').addEventListener('click', () => {
             // validation and data collection
             addNewItem({ /* collected data object */ });
        });

        // Make sure all old button handlers are replaced by the new system.
        // A placeholder for the full, refactored script logic would go here.
        // The key is separating data management (add, delete, save) from the event listeners.

    </script>
</body>
</html>
